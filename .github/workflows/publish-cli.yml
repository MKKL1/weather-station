name: Publish CLI to PyPI

on:
  push:
    tags:
      - 'cli-v*'
  workflow_dispatch:

jobs:
  build-and-test:
    uses: ./.github/workflows/build-cli.yml

  publish:
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry build twine
      
      - name: Install CLI dependencies
        working-directory: ./cli
        run: |
          poetry config virtualenvs.create false --local
          poetry install --no-interaction --no-ansi
      
      - name: Run tests (final check)
        working-directory: ./cli
        run: |
          poetry run pytest -q
      
      - name: Build distributions
        working-directory: ./cli
        run: |
          poetry build
      
      - name: Verify distributions
        working-directory: ./cli
        run: |
          ls -la dist/
          python -m twine check dist/*
      
      - name: Upload to Production PyPI
        if: startsWith(github.ref, 'refs/tags/cli-v')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ./cli/dist
          password: ${{ secrets.PYPI_API_TOKEN }}